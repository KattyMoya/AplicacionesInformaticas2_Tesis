<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ==================== PÁGINA DE DETALLE DEL ESPÉCIMEN ==================== -->
    <template id="herbario_specimen_detail" name="Detalle del Espécimen">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure">
                <!-- Encabezado y Botón de Volver -->
                <section class="pt32 pb32 bg-light">
                    <div class="container">
                        <div class="d-flex justify-content-between align-items-center">
                            <h1 class="mb-0 font-italic" t-esc="specimen.taxon_id.name"/>
                            <a href="/especimenes" onclick="if(window.history.length &gt; 1 &amp;&amp; document.referrer &amp;&amp; document.referrer.indexOf(window.location.host) !== -1) { history.back(); return false; }" class="btn btn-secondary">
                                <i class="fa fa-arrow-left"/> Volver
                            </a>
                        </div>
                    </div>
                </section>

                <section class="pt48 pb48">
                    <div class="container">
                        <div class="row">
                            <!-- Columna Izquierda: Imágenes -->
                            <div class="col-lg-6">
                                <!-- Imagen Principal con contenedor de tamaño fijo -->
                                <div class="mb-4 shadow-lg rounded" style="height: 800px; overflow: hidden; background-color: #f8f9fa;">
                                    <t t-if="image_url">
                                        <img id="main_specimen_image" class="img-fluid"
                                            style="width: 100%; height: 100%; object-fit: cover;"
                                            t-att-src="image_url"
                                            t-att-alt="specimen.taxon_id.name"/>
                                    </t>
                                    <t t-else="">
                                        <div class="d-flex align-items-center justify-content-center h-100" style="border: 1px dashed #ccc;">
                                            <div class="text-center text-muted">
                                                <i class="fa fa-leaf fa-5x"/>
                                                <p class="mt-2">Sin imagen principal</p>
                                            </div>
                                        </div>
                                    </t>
                                </div>

                                <!-- Galería de Miniaturas -->
                                <t t-if="len(specimen.image_ids) > 1">
                                    <h6 class="mb-3">Otras Imágenes</h6>
                                    <div class="row">
                                        <t t-foreach="specimen.image_ids" t-as="img">
                                            <div class="col-3 mb-3">
                                                <img class="img-fluid img-thumbnail specimen-thumbnail" 
                                                     t-att-src="f'/web/image/herbario.image/{img.id}/image_data'" 
                                                     t-att-data-full-src="f'/web/image/herbario.image/{img.id}/image_data'"
                                                     style="cursor: pointer; height: 80px; width: 100%; object-fit: cover;" 
                                                     t-att-alt="img.description or 'Imagen'"/>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </div>

                            <!-- Columna Derecha: Información -->
                            <div class="col-lg-6">
                                <!-- Datos Generales -->
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fa fa-sitemap mr-2"/> Datos Generales y Taxonómicos</h5>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm table-borderless">
                                            <tr><td class="font-weight-bold" width="40%">Código Herbario:</td><td t-esc="specimen.codigo_herbario"/></tr>
                                            <tr><td class="font-weight-bold"># Cartulina:</td><td t-esc="specimen.numero_cartulina or 'N/A'"/></tr>
                                            <tr><td class="font-weight-bold">Index:</td><td t-esc="specimen.index_text or 'N/A'"/></tr>
                                            <tr><td class="font-weight-bold">Familia:</td><td t-esc="specimen.taxon_id.family_id.name or 'N/A'"/></tr>
                                            <tr><td class="font-weight-bold">Género:</td><td t-esc="specimen.taxon_id.genero or 'N/A'"/></tr>
                                            <tr><td class="font-weight-bold">Especie:</td><td t-esc="specimen.taxon_id.especie or 'N/A'"/></tr>
                                            <tr><td class="font-weight-bold">Autor:</td><td t-esc="', '.join(specimen.author_ids.mapped('name')) or 'N/A'"/></tr>
                                            <tr><td class="font-weight-bold">Herbario(s):</td><td t-esc="', '.join(specimen.herbarium_ids.mapped('name')) or 'N/A'"/></tr>
                                            <tr><td class="font-weight-bold">Determinador:</td><td t-esc="', '.join(specimen.determiner_ids.mapped('name')) or 'N/A'"/></tr>
                                            <tr><td class="font-weight-bold">Colector(es):</td><td t-esc="', '.join(specimen.collector_ids.mapped('name')) or 'N/A'"/></tr>
                                        </table>
                                    </div>
                                </div>

                                <!-- Ubicaciones de Recolección -->
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="fa fa-map-marker mr-2"/> Ubicaciones de Recolección</h5>
                                    </div>
                                    <div class="card-body">
                                        <t t-if="specimen.collection_site_ids">
                                            <t t-foreach="specimen.collection_site_ids" t-as="loc">
                                                <div class="mb-3 pb-3" t-att-class="'border-bottom' if not loc_last else ''">
                                                    <h6 class="text-success">
                                                        <t t-if="loc.is_primary"><i class="fa fa-star text-warning"/> </t>
                                                        Ubicación <t t-esc="loc_index + 1"/>
                                                    </h6>
                                                    <table class="table table-sm table-borderless mb-0">
                                                        <tr t-if="loc.fecha_recoleccion"><td class="font-weight-bold" width="40%">Fecha de Colección:</td><td t-esc="loc.fecha_recoleccion.strftime('%d/%m/%Y')"/></tr>
                                                        <tr t-if="loc.country_id"><td class="font-weight-bold">País:</td><td t-esc="loc.country_id.name"/></tr>
                                                        <tr t-if="loc.province_id"><td class="font-weight-bold">Provincia:</td><td t-esc="loc.province_id.name"/></tr>
                                                        <tr t-if="loc.lower_id"><td class="font-weight-bold">Cantón:</td><td t-esc="loc.lower_id.name"/></tr>
                                                        <tr t-if="loc.locality_id"><td class="font-weight-bold">Localidad:</td><td t-esc="loc.locality_id.name"/></tr>
                                                        <tr t-if="loc.latitude and loc.longitude">
                                                            <td class="font-weight-bold">Coordenadas:</td>
                                                            <td>
                                                                <a t-if="loc.maps_url" t-att-href="loc.maps_url" target="_blank" class="btn btn-xs btn-outline-primary ml-2"><i class="fa fa-map"/> Ver Mapa</a>
                                                            </td>
                                                        </tr>
                                                        <tr t-if="loc.elevation"><td class="font-weight-bold">Elevación:</td><td><t t-esc="loc.elevation"/> msnm</td></tr>
                                                    </table>
                                                </div>
                                            </t>
                                        </t>
                                        <t t-else="">
                                            <p class="text-muted mb-0">No hay información de ubicación disponible.</p>
                                        </t>
                                    </div>
                                </div>

                                <!-- Descripción -->
                                <t t-if="specimen.description_specimen">
                                    <div class="card shadow-sm">
                                        <div class="card-header bg-info text-white">
                                            <h5 class="mb-0"><i class="fa fa-align-left mr-2"/> Descripción Botánica</h5>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-0" t-esc="specimen.description_specimen"/>
                                        </div>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Script para la galería de imágenes -->
                <script type="text/javascript">
                    odoo.define('herbario_espoch.specimen_gallery', function (require) {
                        'use strict';
                        var publicWidget = require('web.public.widget');
                        publicWidget.registry.SpecimenGallery = publicWidget.Widget.extend({
                            selector: '.specimen-thumbnail',
                            events: { 'click': '_onThumbnailClick' },
                            _onThumbnailClick: function (ev) {
                                $('#main_specimen_image').attr('src', $(ev.currentTarget).data('full-src'));
                            },
                        });
                    });
                </script>
            </div>
        </t>
    </template>

    <!-- ==================== PÁGINA DE ESTADÍSTICAS Y MAPA ==================== -->
    <template id="herbario_statistics_page" name="Estadísticas y Mapa">
        <t t-call="website.layout">
            <t t-set="head" t-value="False"/>
            
            <div id="wrap" class="oe_structure">
                <section class="pt32 pb32 bg-light">
                    <div class="container">
                        <div class="d-flex justify-content-between align-items-center">
                            <h1 class="mb-0">Estadísticas y Georreferencia</h1>
                        </div>
                    </div>
                </section>

                <section class="py-5" id="herbario_statistics_section">
                    <div class="container-fluid">
                        <div class="row">
                            <!-- Barra lateral de filtros (izquierda) -->
                            <div class="col-lg-3" id="stats_filters_sidebar">
                                <div class="card shadow-sm sticky-top" style="top: 20px;">
                                    <div class="card-header bg-dark text-white">
                                        <i class="fa fa-filter"/> Filtros
                                    </div>
                                    <div id="stats_filters_content" class="card-body">
                                        <div class="text-center">Cargando filtros...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Contenido principal (centro) -->
                            <div class="col-lg-9" id="stats_main_content">
                                <!-- Contenedor para el gráfico -->
                                <div id="stats_chart_container" class="card mb-4 shadow-sm">
                                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" style="position: relative; overflow: visible;">
                                        <span id="chart_title">Especímenes por Familia</span>
                                        <div style="position: relative;">
                                            <button class="btn btn-sm btn-light" type="button" id="dropdownGroupButton">
                                                Agrupar por <i class="fa fa-caret-down ml-1"></i>
                                            </button>
                                            <div id="chart_group_selector" style="display: none; position: absolute; right: 0; top: 100%; z-index: 9999; min-width: 160px; background-color: white; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); margin-top: 5px;">
                                                <a class="dropdown-item-chart-group chart-group-item active" href="#" data-group="family">Familia</a>
                                                <a class="dropdown-item-chart-group chart-group-item" href="#" data-group="genus">Género</a>
                                                <a class="dropdown-item-chart-group chart-group-item" href="#" data-group="species">Especie</a>
                                                <a class="dropdown-item-chart-group chart-group-item" href="#" data-group="province">Provincia</a>
                                                <a class="dropdown-item-chart-group chart-group-item" href="#" data-group="collector">Colector</a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body" style="min-height: 400px;">
                                        <canvas id="familyChart"></canvas>
                                    </div>
                                </div>

                                <!-- Contenedor para el mapa -->
                                <div id="stats_map_container" class="card shadow-sm">
                                    <div class="card-header bg-success text-white">Mapa de Distribución</div>
                                    <div id="leaflet_map" style="height: 600px;"></div>
                                </div>
                            </div>

                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Scripts y estilos INLINE para evitar problemas de carga-->
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"/>
            
            <!-- Script de inicialización que maneja dependencias -->
            <script type="text/javascript">
                <![CDATA[
                (function() {
                    // Función para cargar scripts de manera controlada
                    function loadScript(src, callback) {
                        var script = document.createElement('script');
                        script.src = src;
                        script.onload = callback;
                        script.onerror = function() {
                            console.error('Error cargando script: ' + src);
                            if (callback) callback(false);
                        };
                        document.body.appendChild(script);
                    }
                    
                    // Verificar si jQuery ya está cargado (por Odoo)
                    var jqueryLoaded = typeof window.jQuery !== 'undefined';
                    
                    // Función para cargar Select2 después de jQuery
                    function loadSelect2() {
                        if (typeof $.fn.select2 === 'undefined') {
                            loadScript('https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js', function(success) {
                                if (success) {
                                    console.log('Select2 cargado correctamente');
                                    // Inicializar Select2 cuando esté disponible
                                    initSelect2WhenReady();
                                }
                            });
                        } else {
                            console.log('Select2 ya está cargado');
                            initSelect2WhenReady();
                        }
                    }
                    
                    // Función para inicializar Select2 cuando esté listo
                    function initSelect2WhenReady() {
                        var attempts = 0;
                        function tryInit() {
                            attempts++;
                            if (typeof $.fn.select2 !== 'undefined') {
                                console.log('Inicializando Select2...');
                                $('.stats-filter-select').select2({
                                    placeholder: 'Seleccione una o más opciones',
                                    allowClear: true,
                                });
                                console.log('Select2 inicializado');
                            } else if (attempts < 10) {
                                setTimeout(tryInit, 500);
                            } else {
                                console.warn('No se pudo inicializar Select2 después de 10 intentos');
                            }
                        }
                        setTimeout(tryInit, 100);
                    }
                    
                    // Función para cargar Chart.js
                    function loadChartJS() {
                        if (typeof Chart === 'undefined') {
                            loadScript('https://cdn.jsdelivr.net/npm/chart.js', function(success) {
                                if (success) {
                                    console.log('Chart.js cargado correctamente');
                                }
                            });
                        } else {
                            console.log('Chart.js ya está cargado');
                        }
                    }
                    
                    // Función para cargar Leaflet
                    function loadLeaflet() {
                        if (typeof L === 'undefined') {
                            loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js', function(success) {
                                if (success) {
                                    console.log('Leaflet cargado correctamente');
                                }
                            });
                        } else {
                            console.log('Leaflet ya está cargado');
                        }
                    }
                    
                    // Cargar jQuery si no está disponible
                    if (!jqueryLoaded) {
                        console.log('jQuery no detectado, cargando...');
                        loadScript('https://code.jquery.com/jquery-3.6.4.min.js', function(success) {
                            if (success) {
                                console.log('jQuery cargado correctamente');
                                // Cargar dependencias que necesitan jQuery
                                loadSelect2();
                                // Agregar jQuery al namespace de Odoo para compatibilidad
                                if (typeof odoo !== 'undefined') {
                                    odoo.define('jquery', function() {
                                        return window.jQuery;
                                    });
                                }
                            }
                        });
                    } else {
                        console.log('jQuery ya está cargado');
                        loadSelect2();
                    }
                    
                    // Cargar otras bibliotecas
                    loadChartJS();
                    loadLeaflet();
                    
                    // Script para manejar el dropdown de agrupación
                    document.addEventListener('DOMContentLoaded', function() {
                        // Vincular evento al botón del dropdown
                        var dropdownButton = document.getElementById('dropdownGroupButton');
                        var dropdownMenu = document.getElementById('chart_group_selector');
                        
                        if (dropdownButton && dropdownMenu) {
                            dropdownButton.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                
                                var isVisible = dropdownMenu.style.display === 'block';
                                dropdownMenu.style.display = isVisible ? 'none' : 'block';
                                
                                console.log('Dropdown visible:', !isVisible);
                            });
                            
                            // Cerrar dropdown al hacer clic fuera
                            document.addEventListener('click', function(e) {
                                if (!dropdownButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
                                    dropdownMenu.style.display = 'none';
                                }
                            });
                        }
                    });
                    
                })();
                ]]>
            </script>
            
        </t>
    </template>

    <!-- ==================== PÁGINA DE ESPÉCIMEN NO DISPONIBLE ==================== -->
    <template id="herbario_specimen_not_found" name="Espécimen No Disponible">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure">
                <div class="container py-5 text-center">
                    <div class="alert alert-warning shadow-sm" role="alert" style="display: inline-block; min-width: 50%;">
                        <h1 class="display-4"><i class="fa fa-exclamation-triangle text-warning"/></h1>
                        <h3 class="alert-heading mt-3">Espécimen No Disponible</h3>
                        <p class="lead">La información de este espécimen no es pública o se encuentra en proceso de revisión.</p>
                        <hr/>
                        <a href="/" class="btn btn-primary mt-3">Volver al Inicio</a>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>