<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- 
    COMENTADO: Este archivo define vistas para un modelo "herbario.security.audit" que no existe
    en la arquitectura actual. La auditoría de seguridad/cambios se gestiona mediante:
    - herbario.audit.log: para registrar cambios en entidades (specimen, image, qr, taxon)
    - herbario_security.xml: para definir grupos de seguridad y reglas de acceso
    
    Este archivo puede ser reactivado en futuro si se requiere un subsistema separado de auditoría
    de seguridad de login/permisos, pero actualmente no es necesario.
    -->
    
    <!-- Vista de Logs de Seguridad - DESACTIVADA
    <record id="view_security_audit_tree" model="ir.ui.view">
        <field name="name">herbario.security.audit.tree</field>
        <field name="model">herbario.security.audit</field>
        <field name="arch" type="xml">
            <tree string="Logs de Seguridad" decoration-danger="severity=='critical'" 
                  decoration-warning="severity=='warning'" decoration-info="severity=='info'">
                <field name="timestamp"/>
                <field name="event_type"/>
                <field name="user_login"/>
                <field name="ip_address"/>
                <field name="severity"/>
                <field name="description"/>
            </tree>
        </field>
    </record>

    <record id="view_security_audit_form" model="ir.ui.view">
        <field name="name">herbario.security.audit.form</field>
        <field name="model">herbario.security.audit</field>
        <field name="arch" type="xml">
            <form string="Detalle de Log de Seguridad" create="false" edit="false">
                <sheet>
                    <group>
                        <group>
                            <field name="timestamp" readonly="1"/>
                            <field name="event_type" readonly="1"/>
                            <field name="severity" readonly="1"/>
                            <field name="user_id" readonly="1"/>
                            <field name="user_login" readonly="1"/>
                        </group>
                        <group>
                            <field name="ip_address" readonly="1"/>
                            <field name="user_agent" readonly="1"/>
                            <field name="session_id" readonly="1"/>
                        </group>
                    </group>
                    <group>
                        <field name="description" readonly="1"/>
                        <field name="details" readonly="1"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_security_audit_search" model="ir.ui.view">
        <field name="name">herbario.security.audit.search</field>
        <field name="model">herbario.security.audit</field>
        <field name="arch" type="xml">
            <search string="Buscar Logs de Seguridad">
                <field name="user_login"/>
                <field name="ip_address"/>
                <field name="event_type"/>
                
                <filter name="filter_today" string="Hoy" 
                        domain="[('timestamp', '>=', datetime.datetime.now().strftime('%Y-%m-%d 00:00:00'))]"/>
                <filter name="filter_this_week" string="Esta Semana" 
                        domain="[('timestamp', '>=', (context_today() - datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                
                <separator/>
                <filter name="filter_failed_logins" string="Logins Fallidos" 
                        domain="[('event_type', '=', 'login_failed')]"/>
                <filter name="filter_locked_accounts" string="Cuentas Bloqueadas" 
                        domain="[('event_type', '=', 'account_locked')]"/>
                <filter name="filter_critical" string="Críticos" 
                        domain="[('severity', '=', 'critical')]"/>
                
                <group expand="0" string="Agrupar por">
                    <filter name="group_event" string="Tipo de Evento" context="{'group_by': 'event_type'}"/>
                    <filter name="group_user" string="Usuario" context="{'group_by': 'user_login'}"/>
                    <filter name="group_ip" string="IP" context="{'group_by': 'ip_address'}"/>
                    <filter name="group_date" string="Fecha" context="{'group_by': 'timestamp'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Acción para Logs de Seguridad -->
    <record id="action_security_audit" model="ir.actions.act_window">
        <field name="name">Logs de Seguridad</field>
        <field name="res_model">herbario.security.audit</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{'search_default_filter_this_week': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay logs de seguridad registrados
            </p>
            <p>
                Los eventos de seguridad se registran automáticamente.
            </p>
        </field>
    </record>

    <!-- Vista mejorada de usuarios con seguridad -->
    <record id="view_res_users_security_form" model="ir.ui.view">
        <field name="name">res.users.security.form</field>
        <field name="model">res.users</field>
        <field name="inherit_id" ref="base.view_users_form"/>
        <field name="arch" type="xml">
            <xpath expr="//sheet" position="before">
                <header>
                    <button name="action_unlock_account" type="object" 
                            string="Desbloquear Cuenta" 
                            class="btn-warning"
                            invisible="not account_locked"
                            groups="base.group_system"/>
                </header>
            </xpath>
            
            <xpath expr="//page[@name='access_rights']" position="after">
                <page string="Seguridad" name="security_info">
                    <group>
                        <group string="Estado de Seguridad">
                            <field name="account_locked" readonly="1"/>
                            <field name="failed_login_attempts" readonly="1"/>
                            <field name="last_failed_attempt" readonly="1"/>
                            <field name="password_last_changed" readonly="1"/>
                        </group>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Agregar al menú de Configuración - DESACTIVADO
    <menuitem 
        id="menu_security_audit"
        name="Logs de Seguridad"
        parent="herbario_menu_config"
        action="action_security_audit"
        sequence="30"/>
    -->
</odoo>